{"version":3,"file":"prosekit-extensions-image.js","names":["attrs: ImageAttrs","positions: number[]","width: number | null","height: number | null","defaultOnError: ImageUploadErrorHandler","handlePaste: FilePasteHandler","handleDrop: FileDropHandler"],"sources":["../src/image/image-commands/insert-image.ts","../src/image/image-commands/upload-image.ts","../src/image/image-commands.ts","../src/image/image-spec.ts","../src/image/image.ts","../src/image/image-upload-handler.ts"],"sourcesContent":["import { insertNode } from '@prosekit/core'\nimport type { Command } from '@prosekit/pm/state'\n\nimport type { ImageAttrs } from '../image-spec'\n\n/**\n * Returns a command that inserts an image node with the given attributes at the\n * current selection position.\n *\n * @public\n */\nexport function insertImage(attrs?: ImageAttrs): Command {\n  return insertNode({ type: 'image', attrs })\n}\n","import {\n  insertNode,\n  ProseKitError,\n} from '@prosekit/core'\nimport type { Command } from '@prosekit/pm/state'\nimport type { EditorView } from '@prosekit/pm/view'\n\nimport {\n  UploadTask,\n  type Uploader,\n} from '../../file'\nimport type { ImageAttrs } from '../image-spec'\n\n/**\n * Options for {@link uploadImage}.\n *\n * @public\n */\nexport interface UploadImageOptions {\n  /**\n   * The uploader used to upload the file. It should return a promise that\n   * resolves to the URL of the uploaded image.\n   */\n  uploader: Uploader<string>\n  /**\n   * The file that will be uploaded.\n   */\n  file: File\n  /**\n   * The position where the image should be inserted. If not provided, the\n   * image is inserted at the current selection.\n   */\n  pos?: number\n  /**\n   * A handler to be called when an error occurs during the upload.\n   */\n  onError?: ImageUploadErrorHandler\n}\n\n/**\n * Options for the {@link ImageUploadErrorHandler} callback.\n *\n * @public\n */\nexport interface ImageUploadErrorHandlerOptions {\n  /**\n   * The file that was uploaded.\n   */\n  file: File\n  /**\n   * The error that occurred during the upload.\n   */\n  error: unknown\n  /**\n   * The upload task that was used to upload the file.\n   */\n  uploadTask: UploadTask<string>\n}\n\n/**\n * A handler to be called when an error occurs during the upload.\n *\n * @public\n */\nexport type ImageUploadErrorHandler = (options: ImageUploadErrorHandlerOptions) => void\n\n/**\n * Returns a command that uploads an image file and inserts an image node with a\n * temporary URL which is replaced once the upload completes.\n *\n * @param options\n *\n * @public\n */\nexport function uploadImage({ uploader, file, pos, onError }: UploadImageOptions): Command {\n  return (state, dispatch, view) => {\n    const uploadTask = new UploadTask({ file, uploader })\n    const objectURL = uploadTask.objectURL\n    const attrs: ImageAttrs = { src: objectURL }\n\n    uploadTask.finished\n      .then((resultURL) => {\n        if (view && view.isDestroyed) {\n          return\n        } else if (typeof resultURL !== 'string') {\n          const error = new ProseKitError(\n            `Unexpected upload result. Expected a string but got ${typeof resultURL}`,\n          )\n          onError?.({ file, error, uploadTask })\n        } else if (!view) {\n          const error = new ProseKitError(\n            'View must be available to replace the image URL',\n          )\n          onError?.({ file, error, uploadTask })\n        } else {\n          replaceImageURL(view, objectURL, resultURL)\n          UploadTask.delete(objectURL)\n        }\n      })\n      .catch((error) => {\n        onError?.({ file, error, uploadTask })\n      })\n\n    return insertNode({ type: 'image', attrs, pos })(state, dispatch, view)\n  }\n}\n\n/**\n * Replaces the temporary image URL with the final uploaded URL.\n *\n * @internal\n */\nexport function replaceImageURL(\n  view: EditorView,\n  oldURL: string,\n  newURL: string,\n): void {\n  const positions: number[] = []\n  view.state.doc.descendants((node, pos) => {\n    if (node.type.name === 'image') {\n      const attrs = node.attrs as ImageAttrs\n      if (attrs.src === oldURL) {\n        positions.push(pos)\n      }\n    }\n  })\n\n  if (positions.length === 0) {\n    return\n  }\n\n  const tr = view.state.tr\n  for (const pos of positions) {\n    tr.setNodeAttribute(pos, 'src', newURL)\n  }\n  view.dispatch(tr)\n}\n","import {\n  defineCommands,\n  type Extension,\n} from '@prosekit/core'\n\nimport { insertImage } from './image-commands/insert-image'\nimport {\n  uploadImage,\n  type UploadImageOptions,\n} from './image-commands/upload-image'\nimport type { ImageAttrs } from './image-spec'\n\n/**\n * @internal\n */\nexport type ImageCommandsExtension = Extension<{\n  Commands: {\n    insertImage: [attrs?: ImageAttrs]\n    uploadImage: [options: UploadImageOptions]\n  }\n}>\n\n/**\n * @internal\n */\nexport function defineImageCommands(): ImageCommandsExtension {\n  return defineCommands({\n    insertImage,\n    uploadImage,\n  })\n}\n","import {\n  defineNodeSpec,\n  type Extension,\n} from '@prosekit/core'\n\n/**\n * @public\n */\nexport interface ImageAttrs {\n  src?: string | null\n  width?: number | null\n  height?: number | null\n}\n\n/**\n * @internal\n */\nexport type ImageSpecExtension = Extension<{\n  Nodes: {\n    image: ImageAttrs\n  }\n}>\n\n/**\n * @internal\n */\nexport function defineImageSpec(): ImageSpecExtension {\n  return defineNodeSpec({\n    name: 'image',\n    attrs: {\n      src: { default: null, validate: 'string|null' },\n      width: { default: null, validate: 'number|null' },\n      height: { default: null, validate: 'number|null' },\n    },\n    group: 'block',\n    defining: true,\n    draggable: true,\n    parseDOM: [\n      {\n        tag: 'img[src]',\n        getAttrs: (element): ImageAttrs => {\n          if (typeof element === 'string') {\n            return { src: null }\n          }\n\n          const src = element.getAttribute('src') || null\n\n          let width: number | null = null\n          let height: number | null = null\n\n          const rect = element.getBoundingClientRect()\n          if (rect.width > 0 && rect.height > 0) {\n            width = rect.width\n            height = rect.height\n          } else if (\n            element instanceof HTMLImageElement\n            && element.naturalWidth > 0\n            && element.naturalHeight > 0\n          ) {\n            width = element.naturalWidth\n            height = element.naturalHeight\n          }\n          return { src, width, height }\n        },\n      },\n    ],\n    toDOM(node) {\n      const attrs = node.attrs as ImageAttrs\n      return ['img', attrs]\n    },\n  })\n}\n","import {\n  union,\n  type Union,\n} from '@prosekit/core'\n\nimport {\n  defineImageCommands,\n  type ImageCommandsExtension,\n} from './image-commands'\nimport {\n  defineImageSpec,\n  type ImageSpecExtension,\n} from './image-spec'\n\n/**\n * @internal\n */\nexport type ImageExtension = Union<[ImageSpecExtension, ImageCommandsExtension]>\n\n/**\n * @public\n */\nexport function defineImage(): ImageExtension {\n  return union(defineImageSpec(), defineImageCommands())\n}\n","import {\n  union,\n  type PlainExtension,\n} from '@prosekit/core'\n\nimport {\n  defineFileDropHandler,\n  defineFilePasteHandler,\n  type FileDropHandler,\n  type FileDropHandlerOptions,\n  type FilePasteHandler,\n  type FilePasteHandlerOptions,\n  type Uploader,\n} from '../file'\n\nimport {\n  uploadImage,\n  type ImageUploadErrorHandler,\n} from './image-commands/upload-image'\n\n/**\n * A predicate to determine if the pasted file should be uploaded and inserted as an image.\n */\nexport type ImageCanPastePredicate = (options: FilePasteHandlerOptions) => boolean\n\n/**\n * A predicate to determine if the dropped file should be uploaded and inserted as an image.\n */\nexport type ImageCanDropPredicate = (options: FileDropHandlerOptions) => boolean\n\n/**\n * A handler to be called when an error occurs during the upload.\n */\nexport interface ImageUploadHandlerOptions {\n  /**\n   * The uploader used to upload the file. It should return a promise that\n   * resolves to the URL of the uploaded image.\n   */\n  uploader: Uploader<string>\n  /**\n   * A predicate to determine if the pasted file should be uploaded and inserted as an image.\n   * If not provided, it defaults to only allowing paste of files with a content type starting with `image/`.\n   */\n  canPaste?: ImageCanPastePredicate\n  /**\n   * A predicate to determine if the dropped file should be uploaded and inserted as an image.\n   * If not provided, it defaults to only allowing drop of files with a content type starting with `image/`.\n   */\n  canDrop?: ImageCanDropPredicate\n  /**\n   * A handler to be called when an error occurs during the upload.\n   * If not provided, it defaults to logging the error to the console.\n   */\n  onError?: ImageUploadErrorHandler\n}\n\nfunction defaultCanUpload({ file }: { file: File }): boolean {\n  // Only handle image files by default\n  return file.type.startsWith('image/')\n}\n\nconst defaultOnError: ImageUploadErrorHandler = ({ error }) => {\n  console.error('[prosekit] Failed to upload image:', error)\n}\n\n/**\n * Returns an extension that handles image file uploads when pasting or dropping\n * images into the editor.\n *\n * @param options\n */\nexport function defineImageUploadHandler({\n  uploader,\n  canPaste = defaultCanUpload,\n  canDrop = defaultCanUpload,\n  onError = defaultOnError,\n}: ImageUploadHandlerOptions): PlainExtension {\n  const handlePaste: FilePasteHandler = (options) => {\n    if (!canPaste(options)) return false\n    const { view, file } = options\n    const command = uploadImage({ uploader, file, onError })\n    return command(view.state, view.dispatch, view)\n  }\n\n  const handleDrop: FileDropHandler = (options) => {\n    if (!canDrop(options)) return false\n    const { view, file, pos } = options\n    const command = uploadImage({ uploader, file, onError, pos })\n    return command(view.state, view.dispatch, view)\n  }\n\n  return union(\n    defineFilePasteHandler(handlePaste),\n    defineFileDropHandler(handleDrop),\n  )\n}\n"],"mappings":";;;;;;;;;;AAWA,SAAgB,YAAY,OAA6B;AACvD,QAAO,WAAW;EAAE,MAAM;EAAS;EAAO,CAAC;;;;;;;;;;;;;AC8D7C,SAAgB,YAAY,EAAE,UAAU,MAAM,KAAK,WAAwC;AACzF,SAAQ,OAAO,UAAU,SAAS;EAChC,MAAM,aAAa,IAAI,WAAW;GAAE;GAAM;GAAU,CAAC;EACrD,MAAM,YAAY,WAAW;EAC7B,MAAMA,QAAoB,EAAE,KAAK,WAAW;AAE5C,aAAW,SACR,MAAM,cAAc;AACnB,OAAI,QAAQ,KAAK,YACf;YACS,OAAO,cAAc,UAAU;IACxC,MAAM,QAAQ,IAAI,cAChB,uDAAuD,OAAO,YAC/D;AACD,cAAU;KAAE;KAAM;KAAO;KAAY,CAAC;cAC7B,CAAC,MAAM;IAChB,MAAM,QAAQ,IAAI,cAChB,kDACD;AACD,cAAU;KAAE;KAAM;KAAO;KAAY,CAAC;UACjC;AACL,oBAAgB,MAAM,WAAW,UAAU;AAC3C,eAAW,OAAO,UAAU;;IAE9B,CACD,OAAO,UAAU;AAChB,aAAU;IAAE;IAAM;IAAO;IAAY,CAAC;IACtC;AAEJ,SAAO,WAAW;GAAE,MAAM;GAAS;GAAO;GAAK,CAAC,CAAC,OAAO,UAAU,KAAK;;;;;;;;AAS3E,SAAgB,gBACd,MACA,QACA,QACM;CACN,MAAMC,YAAsB,EAAE;AAC9B,MAAK,MAAM,IAAI,aAAa,MAAM,QAAQ;AACxC,MAAI,KAAK,KAAK,SAAS,SAErB;OADc,KAAK,MACT,QAAQ,OAChB,WAAU,KAAK,IAAI;;GAGvB;AAEF,KAAI,UAAU,WAAW,EACvB;CAGF,MAAM,KAAK,KAAK,MAAM;AACtB,MAAK,MAAM,OAAO,UAChB,IAAG,iBAAiB,KAAK,OAAO,OAAO;AAEzC,MAAK,SAAS,GAAG;;;;;;;;AC9GnB,SAAgB,sBAA8C;AAC5D,QAAO,eAAe;EACpB;EACA;EACD,CAAC;;;;;;;;ACHJ,SAAgB,kBAAsC;AACpD,QAAO,eAAe;EACpB,MAAM;EACN,OAAO;GACL,KAAK;IAAE,SAAS;IAAM,UAAU;IAAe;GAC/C,OAAO;IAAE,SAAS;IAAM,UAAU;IAAe;GACjD,QAAQ;IAAE,SAAS;IAAM,UAAU;IAAe;GACnD;EACD,OAAO;EACP,UAAU;EACV,WAAW;EACX,UAAU,CACR;GACE,KAAK;GACL,WAAW,YAAwB;AACjC,QAAI,OAAO,YAAY,SACrB,QAAO,EAAE,KAAK,MAAM;IAGtB,MAAM,MAAM,QAAQ,aAAa,MAAM,IAAI;IAE3C,IAAIC,QAAuB;IAC3B,IAAIC,SAAwB;IAE5B,MAAM,OAAO,QAAQ,uBAAuB;AAC5C,QAAI,KAAK,QAAQ,KAAK,KAAK,SAAS,GAAG;AACrC,aAAQ,KAAK;AACb,cAAS,KAAK;eAEd,mBAAmB,oBAChB,QAAQ,eAAe,KACvB,QAAQ,gBAAgB,GAC3B;AACA,aAAQ,QAAQ;AAChB,cAAS,QAAQ;;AAEnB,WAAO;KAAE;KAAK;KAAO;KAAQ;;GAEhC,CACF;EACD,MAAM,MAAM;AAEV,UAAO,CAAC,OADM,KAAK,MACE;;EAExB,CAAC;;;;;;;;AChDJ,SAAgB,cAA8B;AAC5C,QAAO,MAAM,iBAAiB,EAAE,qBAAqB,CAAC;;;;;ACiCxD,SAAS,iBAAiB,EAAE,QAAiC;AAE3D,QAAO,KAAK,KAAK,WAAW,SAAS;;AAGvC,MAAMC,kBAA2C,EAAE,YAAY;AAC7D,SAAQ,MAAM,sCAAsC,MAAM;;;;;;;;AAS5D,SAAgB,yBAAyB,EACvC,UACA,WAAW,kBACX,UAAU,kBACV,UAAU,kBACkC;CAC5C,MAAMC,eAAiC,YAAY;AACjD,MAAI,CAAC,SAAS,QAAQ,CAAE,QAAO;EAC/B,MAAM,EAAE,MAAM,SAAS;AAEvB,SADgB,YAAY;GAAE;GAAU;GAAM;GAAS,CAAC,CACzC,KAAK,OAAO,KAAK,UAAU,KAAK;;CAGjD,MAAMC,cAA+B,YAAY;AAC/C,MAAI,CAAC,QAAQ,QAAQ,CAAE,QAAO;EAC9B,MAAM,EAAE,MAAM,MAAM,QAAQ;AAE5B,SADgB,YAAY;GAAE;GAAU;GAAM;GAAS;GAAK,CAAC,CAC9C,KAAK,OAAO,KAAK,UAAU,KAAK;;AAGjD,QAAO,MACL,uBAAuB,YAAY,EACnC,sBAAsB,WAAW,CAClC"}